<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNO Game - Festive Edition</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <style>
    /* Card image styling */
    .card-img {
      width: 80px;
      height: 120px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      /* Transition to make the rise animation work */
      transition: transform 0.1s ease-in-out;
    }

    /* Hover animation to make the cards rise */
    .card-img:hover {
      transform: translateY(-5px);
    }

    /* container for cards */
    .christmas-container {
      background-color: rgba(0, 0, 0, 0.4);
      border: 2px solid #cc0000; /* Red border */
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    /* christmas themed button */
    .christmas-btn {
      background-color: #006600; /* Green */
      color: white;
      transition: background-color 0.2s;
    }

    /* Hover animation for christmas button */
    .christmas-btn:hover {
      background-color: #008000;
    }

    /*Colour option container option */
    .color-option {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid white;
        transition: transform 0.1s;
    }

    /* Hover animation for hover */
    .color-option:hover {
        transform: scale(1.1);
    }
  </style>
</head>

<!-- Background styling for the page -->
<body class="text-white p-6" style="background-color: #3b0000;">

  <!-- background music that is rotated by a javascript function -->
  <audio id="wonder-theme" loop src="./soundtrack/GAMETHEME3-WONDER.mp3"></audio>
  <audio id="voyage-theme" loop src="./soundtrack/GAMETHEME2-VOYAGE.mp3"></audio>
  <audio id="relax-theme" loop src="./soundtrack/GAMETHEME1-RELAX.mp3"></audio>
  <audio id="tense-theme" src="./soundtrack/GAMETHEME4-TENSE.mp3"></audio>

  <!-- Win, loose and start sounds that are triggered by a javascript function -->
  <audio id="win-sound" src="./SFX/VICTORY.mp3"></audio>
  <audio id="lose-sound" src="./SFX/LOST.mp3"></audio>
  <audio id="start-sound" src="./SFX/CHALLENGE.mp3"></audio>
  
  <!-- card sounds that are triggered by a javascript function -->
  <audio id="play-card-sound" src="./SFX/PLACECARD.mp3"></audio>
  <audio id="draw-card-sound" src="./SFX/CARDSWOOSH.mp3"></audio>
  <audio id="plus-two-sound" src="./SFX/PLUS2.mp3"></audio> 
  <audio id="wild-sound" src="./SFX/CARDSWOOSH.mp3"></audio> 

  <!-- Button that toggles music on/off -->
  <button id="musicToggleBtn"
    class="christmas-btn fixed bottom-4 right-4 p-3 rounded-full z-50 font-bold shadow-xl">
    <i class="fas fa-volume-mute"></i> Music
  </button>
  
  <!-- Game page main heading -->
  <h1 class="text-center text-4xl font-extrabold mb-8 text-red-300 drop-shadow-lg">
    <!-- Holly icon -->
    <i class="fas fa-holly-berry mr-2"></i> UNO: Festive Challenge
  </h1>

  <!-- Centered container -->
  <div class="max-w-4xl mx-auto space-y-6">
    <!-- Computer hand -->
    <div class="p-4 rounded christmas-container">
      <h2 class="text-xl font-semibold mb-2 text-yellow-400">Computer's Stocking</h2>
      <!-- Stores the computers cards which are handled via javascript -->
      <div id="computerHand" class="flex flex-wrap gap-3"></div>
    </div>
    
    <!-- Top card container -->
    <div class="p-4 rounded text-center christmas-container">
      <h2 class="text-xl font-semibold text-yellow-400">Top Card (Chimney)</h2>
      <!-- Stores the top card which are handled via javascript -->
      <div id="topCard" class="mt-3 flex justify-center"></div>
    </div>

    <!-- Player hand container -->
    <div class="p-4 rounded christmas-container">
      <h2 class="text-xl font-semibold mb-2 text-yellow-400">Your Hand (Mistletoe)</h2>
      <!-- Stores the cards -->
      <div id="playerHand" class="flex flex-wrap gap-3"></div>
      
      <!-- Draw button to draw a card from the deck -->
      <button id="drawBtn"
        class="christmas-btn mt-6 px-6 py-3 rounded-xl font-extrabold text-xl">
        <!-- Gift icon -->
        <i class="fas fa-gift"></i> Draw Card
      </button>
    </div>

    <!-- Link to return the user to the menu -->
    <div class="text-center">
      <!-- Link back to index page -->
      <a href="index.html" class="text-red-300 hover:text-red-500 underline text-lg font-semibold transition">
        <!-- Chimmy icon -->
        <i class="fas fa-house-chimney"></i> Return to Menu
      </a>
    </div>
    
    <!-- Message box that changes based on javascript function -->
    <div id="message" class="text-center text-xl font-extrabold mt-6"></div>

  </div>

<!-- Colour selector modal -->
<div id="colorSelector" class="hidden flex fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
  <!-- Centered div -->  
  <div class="p-8 rounded christmas-container text-center">
        <!-- Heading text to find new colour -->
        <h3 class="text-2xl font-bold mb-5 text-yellow-400">Choose a New Color</h3>
        <!-- list of colour options -->
        <div id="colorOptions" class="flex justify-center space-x-4">
            <!-- Colour options which are updated based on handle colour select function which uses the colour as a parameter -->
            <div class="color-option bg-red-600" onclick="handleColorSelect('red')"></div>
            <div class="color-option bg-green-600" onclick="handleColorSelect('green')"></div>
            <div class="color-option bg-blue-600" onclick="handleColorSelect('blue')"></div>
            <div class="color-option bg-yellow-400" onclick="handleColorSelect('yellow')"></div>
        </div>
    </div>
</div>

<script>
/* ------------------------------------
      UNO GAME LOGIC
------------------------------------- */

// Defines the core types of cards
const COLORS = ["red", "green", "blue", "yellow"]; // Stores the colours used in the program
const NUMBER_VALUES = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]; // Stores the numbers of main cards
const ACTION_VALUES = ["+2", "miss", "wild", "+4"];  // Stores the original action values for the game

// --- NEW PRESENT CARD CONSTANTS ---
const SNOWBALL_VALUE = "snowball"; // Stores the value of the snowball
const PRESENT_VALUE = "present";  // Stores the present value of the game
// --- UPDATED WILD VALUES TO INCLUDE SNOWBALL AND PRESENT ---
const WILD_VALUES = ["wild", "+4", SNOWBALL_VALUE, PRESENT_VALUE]; // Stores all the wildcards values

const CARD_BACK_IMAGE_PATH = "cards/card_back.png"; // Gets the card back image  

// Stores the current deck
let deck = [];
// Stores the player hand
let playerHand = [];
// Stores the computer hand
let computerHand = [];
// stores the current top card
let topCard = null;

// --- STATE VARIABLES ---

// Flags for if the special cards are active
let plusTwoActive = false; 
let skipActive = false;
let snowballActive = false;
let presentActive = false;
// tracks if the game is over
let gameOver = false;
// tracks the next card in the deck
let pendingPlayIndex = -1; 
// Tracks the current colours
let currentColor = null;

/* ------------------------------------
      ðŸŽµ AUDIO HELPER FUNCTIONS ðŸŽµ
------------------------------------- */

// function that plays the start sound
function playStartSound() { 
    // Gets the audio element of the start sound
    document.getElementById("start-sound").play().catch(e => console.error("Start sound failed:", e)); 
}
// function that plays the play card sound
function playCardSound() { 
    // Gets the audio element of the play card sound
    document.getElementById("play-card-sound").play().catch(e => console.error("Play card sound failed:", e)); 
}
// function that plays the draw card sound
function playDrawSound() { 
    // Gets the audio element of the draw card sound
    document.getElementById("draw-card-sound").play().catch(e => console.error("Draw card failed:", e)); 
}
// function that plays the plus two card sound
function playPlusTwoSound() { 
    // Gets the audio element of the plus two card sound
    document.getElementById("plus-two-sound").play().catch(e => console.error("Plus two sound failed:", e)); 
}
// function that plays the wild card sound
function playWildSound() { 
    // Gets the audio element of the wild card sound
    document.getElementById("wild-sound").play().catch(e => console.error("Wild sound failed:", e)); 
}
// function that plays the win sound
function playWinSound() { 
    // Gets the audio element of the win sound
    document.getElementById("win-sound").play().catch(e => console.error("Win sound failed:", e)); 
}
// function that plays the loose sound
function playLoseSound() { 
    // Gets the audio element of the lose sound
    document.getElementById("lose-sound").play().catch(e => console.error("Lose sound failed:", e)); 
}


/* -------------------------------------
  Generate Deck Function
------------------------------------- */

function generateDeck() {
  // Stores the deck of cards which will be generated
  deck = [];
  
  // Loops through each of the colours in the colours list
  COLORS.forEach(color => {
    // Loops through the number values
    NUMBER_VALUES.forEach(value => {
      // gets the filename from the colour and the value in the current iteration
      const fileName = `${color}_${value}.png`;
      // Uses the filename variable to get the image path
      const imagePath = `cards/${fileName}`;
      // Stores the card as a dictionary
      const card = { color, value: value.toString(), image: imagePath, type: 'number' };
      // Adds the card to the deck
      deck.push(card); 
      // Checks if the card value is not zero
      if (value !== 0) {
        // Pushs the card to the deck
        deck.push(card); 
      }
    });

    // Loops over the action values and filters out the non wild card values
    ACTION_VALUES.filter(v => !WILD_VALUES.includes(v)).forEach(value => {
      // gets the filename from the colour and the value in the current iteration
      const fileName = `${color}_${value}.png`;
      // Uses the filename variable to get the image path
      const imagePath = `cards/${fileName}`;
      // Stores the card as a dictionary
      const card = { color, value, image: imagePath, type: 'action' };
      // Pushes the cards to the deck
      deck.push(card); 
      deck.push(card); 
    });
  });

  // Loops over the wild values
  WILD_VALUES.forEach(value => {
    // initalises the file name as an empty array  
    let fileName = "";
      // Checks if the value is 'wild'
      if (value === "wild") {
          // Sets the file name to wildcard_1.png
          fileName = "wildcard_1.png";
      // Checks if the value is +4
      } else if (value === "+4") {
          // sets the file name to the plus four file name
          fileName = "card_+4_1.png";
      // Checks if the value is the snow ball value
      } else if (value === SNOWBALL_VALUE) {
          // Sets the file path to be the snowball card path
          fileName = "snowball_card_1.png"; 
      // Checks if the card is the present value
      } else if (value === PRESENT_VALUE) {
        // Sets the file name to the present card path  
        fileName = "present_card_1.png";
      }
      
      // Sets the image path
      const imagePath = `cards/${fileName}`;
      // Sets the wild card infomation as a dictionary
      const card = { color: 'black', value, image: imagePath, type: 'wild' }; 
      
      // Loops through and pushes the cards
      for(let i = 0; i < 4; i++) {
          deck.push({...card, isWild: true}); 
      }
  });
  
  // Randomises the deck
  deck = deck.sort(() => Math.random() - 0.5);
}

/* -------------------------------------
  2. Image Rendering Function
------------------------------------- */
// Gets the image card
function getCardImagePath(card, isFaceUp = true) {
  // Checks if the card is face up
  if (isFaceUp && card) {
    // returns the cards image
    return card.image;
  } else {
    // Returns the cards back image
    return CARD_BACK_IMAGE_PATH;
  }
}

/* Draw card */
function drawCard(hand) {
  // Checks if the card length is zero and genrates the deck
  if (deck.length === 0) {
    // calls the generate deck function
    generateDeck(); 
  }
  // gets the drawncard from the last item in the deck
  const drawnCard = deck.pop();
  // Checks the drawn card
  if (drawnCard) {
      // Adds the drawn card to the hand
      hand.push(drawnCard);
  }
}

/* -------------------------------------
  3. Render Function
------------------------------------- */

function render() {
  // gets the top Card
  const top = document.getElementById("topCard");
  // Sets the inner html to nothing
  top.innerHTML = "";
  // Checks if there is a top card
  if (topCard) {
    // Creates the top image elemetn
    const topImg = document.createElement("img");
    // Gets the src of of of the top image using the get image path function
    topImg.src = getCardImagePath(topCard, true);
    // sets the top image class name  
    topImg.className = "card-img";
    
    // Checks the display colour
    const displayColor = topCard.isWild && currentColor ? currentColor : topCard.color;
    // Sets the alt text
    topImg.alt = `Top Card: ${displayColor} ${topCard.value}`;

    // Checks if the card is wild if there is a current colour
    if (topCard.isWild && currentColor) {
        // Use Christmas colors for wild border
        let borderColor = 'white'; // Sets the border colour to white
        if (currentColor === 'red') borderColor = '#cc0000'; // Sets the border colour to red
        if (currentColor === 'green') borderColor = '#006600'; // sets the border colour to green
        if (currentColor === 'yellow') borderColor = '#ffcc00'; // sets the border colour to yellow
        if (currentColor === 'blue') borderColor = '#004c99'; // sets the border colour to blue

        // Creates a border around the image 
        topImg.style.border = `4px solid ${borderColor}`;
    } else {
        // Sets the border to none
        topImg.style.border = 'none';
    }
    // Adds the top card image to the top card element
    top.appendChild(topImg);
  }


  // Player Hand
  const handDiv = document.getElementById("playerHand");
  handDiv.innerHTML = "";
  
  const isGifting = presentActive && !gameOver;

  playerHand.forEach((card, index) => {
    const img = document.createElement("img");
    img.src = getCardImagePath(card, true); 
    img.className = "card-img";
    
    if (isGifting) {
        img.onclick = () => selectCardToGift(index);
        img.style.border = "4px solid #ffcc00"; // Gold highlight for gifting
    } else if (!gameOver && pendingPlayIndex === -1) {
        img.onclick = () => playCard(index);
    }
    
    img.alt = `${card.color} ${card.value}`; 
    handDiv.appendChild(img);
  });
  
  document.getElementById("drawBtn").disabled = isGifting;

  // Computer Hand 
  const compDiv = document.getElementById("computerHand");
  compDiv.innerHTML = "";
  
  if (snowballActive) {
      const placeholder = document.createElement("div");
      placeholder.className = "text-2xl font-bold text-yellow-400 p-4 border border-yellow-400 rounded christmas-container";
      placeholder.innerText = "â„ï¸ Computer's cards are hidden by the Snowball!";
      compDiv.appendChild(placeholder);
  } else {
      computerHand.forEach(() => {
        const img = document.createElement("img");
        img.src = CARD_BACK_IMAGE_PATH; 
        img.className = "card-img";
        img.alt = "Card Back";
        compDiv.appendChild(img);
      });
  }
}

/* Check if card playable (UNCHANGED) */
function canPlay(card) {
    if (card.isWild) {
        return true; 
    }
    const effectiveTopColor = topCard.isWild && currentColor ? currentColor : topCard.color;

    return card.color === effectiveTopColor || card.value === topCard.value;
}

/* Action Card Logic Helpers (UNCHANGED) */

function applyPlusTwoEffect(targetHand, targetName) {
    if (gameOver) return;

    drawCard(targetHand);
    drawCard(targetHand);
    
    plusTwoActive = false;
    
    if (snowballActive && targetName === "Computer") {
        snowballActive = false;
        setMessage(`Snowball effect cleared! ðŸ’€ ${targetName} draws 2 cards and skips turn!`);
    } else {
        setMessage(`ðŸ’€ ${targetName} draws 2 cards and skips turn!`);
    }
    
    render();
    
    if (targetName === "You") {
        setTimeout(computerTurn, 1000); 
    } else {
        setTimeout(() => {
            setMessage("Your turn now!");
        }, 1000); 
    }
}

function applyPlusFourEffect(targetHand, targetName) {
    if (gameOver) return;

    for (let i = 0; i < 4; i++) {
        drawCard(targetHand);
    }
    
    plusTwoActive = false; 
    
    if (snowballActive && targetName === "Computer") {
        snowballActive = false;
        setMessage(`Snowball effect cleared! ðŸ’€ ${targetName} draws 4 cards and skips turn! New Color: ${currentColor.toUpperCase()}`);
    } else {
        setMessage(`ðŸ’€ ${targetName} draws 4 cards and skips turn! New Color: ${currentColor.toUpperCase()}`);
    }
    
    render();
    
    if (targetName === "You") {
        setTimeout(computerTurn, 1000); 
    } else {
        setTimeout(() => {
            setMessage("Your turn now!");
        }, 1000); 
    }
}

function applySkipEffect(targetName) {
    if (gameOver) return;

    skipActive = false;
    
    if (snowballActive && targetName === "Computer") {
        snowballActive = false;
        setMessage(`Snowball effect cleared! â© ${targetName}'s turn is skipped!`);
    } else {
        setMessage(`â© ${targetName}'s turn is skipped!`);
    }
    
    render();
    
    if (targetName === "You") {
        setTimeout(computerTurn, 1000); 
    } else {
        setTimeout(() => {
            setMessage("Your turn now!");
        }, 1000); 
    }
}

/* Player plays card (UNCHANGED) */
function playCard(index) {
  if (gameOver || pendingPlayIndex !== -1 || presentActive) return;

  const card = playerHand[index];

  if (!canPlay(card)) {
    setMessage("âŒ You can't play that card!");
    return;
  }
  
  if (card.isWild) {
      pendingPlayIndex = index; 
      showColorSelector(); 
      playCardSound(); 
      return; 
  }
  
  topCard = card;
  currentColor = card.color; 
  
  if (snowballActive) {
      snowballActive = false; 
  }
  
  playerHand.splice(index, 1);
  
  playCardSound();
  
  setMessage("You played a card. Computer's turn...");
  render();

  if (checkWinner()) return;

  if (card.value === "+2") {
    plusTwoActive = true; 
    playPlusTwoSound(); 
    setMessage(`You played a +2. Computer must draw 2!`);
  } else if (card.value === "miss") {
    skipActive = true;
    setMessage(`You played a Skip. Computer's turn is skipped!`);
  }
  
  setTimeout(computerTurn, 900);
}

/* Player selects a card to gift (UNCHANGED) */
function selectCardToGift(index) {
    if (!presentActive) return;
    
    const giftedCard = playerHand[index];
    
    playerHand.splice(index, 1);
    computerHand.push(giftedCard);
    
    presentActive = false;
    
    setMessage(`ðŸŽ You gifted a ${giftedCard.color} ${giftedCard.value} to the Computer! Computer's turn is skipped! New Color: ${currentColor.toUpperCase()}`);
    render();
    
    if (checkWinner()) return;

    setTimeout(computerTurn, 900);
}


/* Color Selection Logic for Wild Cards (UNCHANGED) */
function showColorSelector() {
    document.getElementById("colorSelector").classList.remove('hidden');
    document.getElementById("drawBtn").disabled = true;
}

function hideColorSelector() {
    document.getElementById("colorSelector").classList.add('hidden');
    document.getElementById("drawBtn").disabled = false;
    pendingPlayIndex = -1;
}

window.handleColorSelect = function(selectedColor) {
    if (pendingPlayIndex === -1) return;
    
    const card = playerHand[pendingPlayIndex];
    
    topCard = card;
    currentColor = selectedColor; 
    
    playerHand.splice(pendingPlayIndex, 1);
    
    hideColorSelector();

    let messageText = `You played a Wild and chose ${selectedColor.toUpperCase()}. Computer's turn...`;
    
    if (card.value === "+4") {
        playPlusTwoSound(); 
        messageText = `You played a Wild +4! Computer must draw 4! New Color: ${currentColor.toUpperCase()}`;
        setMessage(messageText);
        render();
        if (checkWinner()) return;
        setTimeout(() => {
            applyPlusFourEffect(computerHand, "Computer");
        }, 500);
        return;
    } else if (card.value === SNOWBALL_VALUE) {
        snowballActive = true; 
        skipActive = true;     
        messageText = `â„ï¸ You played a **Snowball**! Computer's cards are hidden, and their turn is skipped! New Color: ${currentColor.toUpperCase()}`;
    } else if (card.value === PRESENT_VALUE) {
        presentActive = true; 
        skipActive = true; 
        messageText = `ðŸŽ You played a **Present Card**! Choose a card to gift to the Computer. Turn is skipped! New Color: ${currentColor.toUpperCase()}`;
        
        setMessage(messageText);
        render();
        return; 
    }
    
    setMessage(messageText);
    render();

    if (checkWinner()) return;
    
    setTimeout(computerTurn, 900);
}


/* Player draws (UNCHANGED) */
document.getElementById("drawBtn").onclick = () => {
  if (gameOver || presentActive) return; 

  if (plusTwoActive) {
    const isPlusFour = topCard && topCard.value === "+4";
    const drawAmount = isPlusFour ? 4 : 2;

    for (let i = 0; i < drawAmount; i++) {
        drawCard(playerHand);
    }
    
    playDrawSound(); 
    setMessage(`You drew ${drawAmount} cards due to the +${drawAmount} penalty. Computer's turn...`);
    plusTwoActive = false; 
  } else {
    drawCard(playerHand);
    playDrawSound(); 
    setMessage("You drew a card. Computer's turn...");
  }
  
  if (snowballActive) {
      snowballActive = false;
  }
  
  render();
  setTimeout(computerTurn, 900);
};

/* Computer turn logic (UNCHANGED) */
function computerTurn() {
    if (gameOver) return;

    if (skipActive) {
        applySkipEffect("Computer");
        return; 
    }
    
    if (plusTwoActive) {
        const isPlusFour = topCard && topCard.value === "+4";
        if (isPlusFour) {
            applyPlusFourEffect(computerHand, "Computer");
        } else {
            applyPlusTwoEffect(computerHand, "Computer");
        }
        return; 
    }
    
    if (snowballActive) {
        snowballActive = false;
        setMessage("Snowball effect cleared! Computer's turn now.");
        render();
    }
    
    let playable = computerHand.find(c => canPlay(c));

    if (playable) {
        
        if (playable.isWild) {
            playWildSound(); 
            
            const colorCounts = {};
            COLORS.forEach(c => colorCounts[c] = computerHand.filter(card => card.color === c && !card.isWild).length);
            
            let bestColor = 'red'; 
            let maxCount = -1;
            
            COLORS.forEach(c => {
                if (colorCounts[c] > maxCount) {
                    maxCount = colorCounts[c];
                    bestColor = c;
                }
            });

            topCard = playable;
            currentColor = bestColor; 

            const playedIndex = computerHand.findIndex(c => c.image === playable.image);
            computerHand.splice(playedIndex, 1);
            
            let messageText = `ðŸ¤– Computer played a Wild Card and chose ${bestColor.toUpperCase()}`;
            
            if (playable.value === SNOWBALL_VALUE) {
                snowballActive = true; 
                skipActive = true;
                messageText = `â„ï¸ ðŸ¤– Computer played a **Snowball**! Your cards are hidden, and your turn is skipped! New Color: ${currentColor.toUpperCase()}`;
            } else if (playable.value === PRESENT_VALUE) {
                skipActive = true;
                
                // Computer selects the best card to give away: a low-value card
                let giftedCardIndex = -1;
                let lowestValue = 10;
                
                computerHand.forEach((card, index) => {
                    const value = parseInt(card.value);
                    if (!isNaN(value) && value < lowestValue) {
                        lowestValue = value;
                        giftedCardIndex = index;
                    }
                });

                const giftedCard = giftedCardIndex !== -1 ? computerHand[giftedCardIndex] : computerHand[0]; 
                
                if (giftedCard) {
                    computerHand.splice(giftedCardIndex !== -1 ? giftedCardIndex : 0, 1);
                    playerHand.push(giftedCard);
                    messageText = `ðŸŽ ðŸ¤– Computer played a **Present Card** and gifted you a ${giftedCard.color} ${giftedCard.value}! Computer's turn is skipped! New Color: ${currentColor.toUpperCase()}`;
                } else {
                    messageText = `ðŸŽ ðŸ¤– Computer played a **Present Card** but had no card to gift! Turn is skipped! New Color: ${currentColor.toUpperCase()}`;
                }
            }
            
            setMessage(messageText);
            render();

            if (checkWinner()) return;

            if (playable.value === "+4") {
                playPlusTwoSound(); 
                setTimeout(() => {
                    applyPlusFourEffect(playerHand, "You");
                }, 500);
                return; 
            }
            
            setTimeout(() => {
                setMessage("Your turn now!");
            }, 500);
            return; 
        }
        
        topCard = playable;
        currentColor = playable.color; 
        
        const playedIndex = computerHand.findIndex(c => c.image === playable.image);
        computerHand.splice(playedIndex, 1);
        
        playCardSound(); 

        setMessage(`ðŸ¤– Computer played ${playable.color} ${playable.value}`);
        
        render();

        if (checkWinner()) return;

        if (playable.value === "+2") {
            plusTwoActive = true; 
            playPlusTwoSound(); 
            setTimeout(() => {
                applyPlusTwoEffect(playerHand, "You");
            }, 500);
            return; 
        } else if (playable.value === "miss") {
             skipActive = true; 
             setTimeout(() => {
                 applySkipEffect("You");
             }, 500);
             return; 
        }
        
    } else {
        drawCard(computerHand);
        playDrawSound(); 
        setMessage("ðŸ¤– Computer drew a card");
        render();
    }

    setTimeout(() => {
        setMessage("Your turn now!");
    }, 500);
}

/* Winner check */
function checkWinner() {
  if (playerHand.length === 0) {
    setMessage("ðŸŽ‰ You win the Festive Challenge! Play again?");
    playWinSound(); 
    disableGame();
    return true;
  }
  if (computerHand.length === 0) {
    setMessage("ðŸ’€ Computer wins! Better luck next Christmas! Play again?");
    playLoseSound(); 
    disableGame();
    return true;
  }
  return false;
}

/* Disable inputs - MODIFIED STYLING */
function disableGame() {
  gameOver = true;
  
  document.getElementById("drawBtn").disabled = true;
  
  const handDiv = document.getElementById("playerHand");
  handDiv.innerHTML = "";
  
  const button = document.createElement("button");
  button.id = "playAgainBtn";
  // Apply Christmas button styling
  button.className = "christmas-btn px-6 py-3 rounded-xl text-2xl font-bold shadow-xl mt-4";
  button.innerText = "ðŸŽ… Start New Game";
  
  button.onclick = () => {
      playStartSound(); 
      setTimeout(() => window.location.reload(), 100); 
  };
  
  handDiv.appendChild(button);
}

/* Message helper (UNCHANGED) */
function setMessage(msg) {
  document.getElementById("message").innerText = msg;
}

/* ------------------------------------
      ðŸŽ¶ MUSIC MANAGER LOGIC ðŸŽ¶ (UNCHANGED)
------------------------------------- */

const themes = ["wonder", "voyage", "relax", "tense"];
let currentThemeIndex = -1;
let currentAudio = null;
let isMusicEnabled = false; 
const TOGGLE_BUTTON = document.getElementById('musicToggleBtn');
let rotationIntervalId = null; 

const MusicManager = {
    playNextTheme() {
        if (!isMusicEnabled) return; 
        this.stopMusic(); 
        currentThemeIndex = (currentThemeIndex + 1) % themes.length;
        const nextThemeId = themes[currentThemeIndex] + "-theme";
        currentAudio = document.getElementById(nextThemeId);
        
        if (currentAudio) {
            currentAudio.volume = 0.5; 
            currentAudio.play().catch(error => console.error("Music playback failed:", error));
        }
    },
    
    stopMusic() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0; 
        }
    },

    startRotation() {
        if (rotationIntervalId) {
            clearInterval(rotationIntervalId);
        }
        this.playNextTheme();
        rotationIntervalId = setInterval(() => this.playNextTheme(), 60000); 
    },
    
    stopRotation() {
        if (rotationIntervalId) {
            clearInterval(rotationIntervalId);
            rotationIntervalId = null;
        }
    },

    toggleMusic() {
        isMusicEnabled = !isMusicEnabled;
        
        if (isMusicEnabled) {
            TOGGLE_BUTTON.innerHTML = '<i class="fas fa-volume-up"></i> Music';
            this.startRotation();
        } else {
            TOGGLE_BUTTON.innerHTML = '<i class="fas fa-volume-mute"></i> Music';
            this.stopRotation();
            this.stopMusic(); 
        }
    }
};

TOGGLE_BUTTON.addEventListener('click', () => {
    MusicManager.toggleMusic();
});


/* -------------------------------------
  START GAME FUNCTION (UNCHANGED)
------------------------------------- */

function startGame() {
  generateDeck();
  playerHand = [];
  computerHand = [];
  gameOver = false; 
  plusTwoActive = false;
  skipActive = false; 
  snowballActive = false;
  presentActive = false;
  pendingPlayIndex = -1; 

  for (let i = 0; i < 7; i++) {
    drawCard(playerHand);
    drawCard(computerHand);
  }

  topCard = deck.pop();
  while (topCard && topCard.isWild) {
      topCard = deck.pop();
  }
  
  if (topCard) {
      currentColor = topCard.color; 
  }

  render();
  setMessage("Game started! Your turn.");
}

/* -------------------------------------
  INITIALIZATION (FIXED)
------------------------------------- */

// Crucial fix: Wait for the entire page to load before starting the game
document.addEventListener('DOMContentLoaded', () => {
    startGame();
    playStartSound();
});

</script>

</body>
</html>